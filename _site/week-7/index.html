<html lang="en_US"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --><title>Week 7 - Spatial regression of areal data | Applied Spatial Data Science for Public Health</title><meta name="generator" content="Jekyll v3.9.1" /><meta property="og:title" content="Week 7 - Spatial regression of areal data" /><meta name="author" content="UC Berkeley School of Public Health" /><meta property="og:locale" content="en_US" /><meta name="description" content="Week 7 - spatial regression of areal data" /><meta property="og:description" content="Week 7 - spatial regression of areal data" /><link rel="canonical" href="http://localhost:4000/week-7/" /><meta property="og:url" content="http://localhost:4000/week-7/" /><meta property="og:site_name" content="Applied Spatial Data Science for Public Health" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-10-10T00:00:00-07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Week 7 - Spatial regression of areal data" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"UC Berkeley School of Public Health"},"dateModified":"2017-10-10T00:00:00-07:00","datePublished":"2017-10-10T00:00:00-07:00","description":"Week 7 - spatial regression of areal data","headline":"Week 7 - Spatial regression of areal data","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/week-7/"},"url":"http://localhost:4000/week-7/"}</script> <!-- End Jekyll SEO tag --><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/icons/apple-touch-icon.png?v=qA3OXqyw77"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/icons/favicon-32x32.png?v=qA3OXqyw77"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/icons/favicon-16x16.png?v=qA3OXqyw77"><link rel="manifest" href="/assets/img/icons/manifest.json?v=qA3OXqyw77"><link rel="mask-icon" href="/assets/img/icons/safari-pinned-tab.svg?v=qA3OXqyw77" color="#5bbad5"> <!--[if IE]><link rel="shortcut icon" href="/assets/img/icons/favicon.ico?v=qA3OXqyw77"><![endif]--><link rel="shortcut icon" href="/assets/img/icons/favicon.ico?v=qA3OXqyw77"><meta name="apple-mobile-web-app-title" content="Sleek"><meta name="application-name" content="Sleek"><meta name="msapplication-config" content="/assets/img/icons/browserconfig.xml?v=qA3OXqyw77"><meta name="theme-color" content="#ffffff"><style class="inlineCSS"> h1{color:#313237;margin-top:0;margin-bottom:.5rem}.dark-bg{background-color:#313237}@media (min-width:48em){.post-card{width:48.4375%;margin-right:3.125%}.post-card:last-of-type,.post-card:nth-child(2n+2){margin-right:0}}html{line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}header,nav,section{display:block}h1{font-size:2em;margin:.67em 0}figure,main{display:block}figure{margin:1em 40px}a{background-color:transparent;-webkit-text-decoration-skip:objects}img{border-style:none}svg:not(:root){overflow:hidden}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{-webkit-box-sizing:border-box;box-sizing:border-box}body{-webkit-overflow-scrolling:touch}*,::after,::before{-webkit-box-sizing:inherit;box-sizing:inherit}.site{display:-webkit-box;display:-ms-flexbox;display:flex;min-height:100vh;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}.site__content{-webkit-box-flex:1;-ms-flex:1;flex:1}img{max-width:100%;height:auto;width:auto;vertical-align:middle}figure{margin:0}body{background-color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";font-size:1rem;line-height:1.5;color:#343851;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%}p{margin-top:0;margin-bottom:1.25rem}h1,h2{color:#313237;margin-top:0;margin-bottom:.5rem}a{color:#277cea;text-decoration:none}.blur{background:#fff;filter:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg"><filter id="filter"><feGaussianBlur stdDeviation="16" /></filter></svg>#filter');-webkit-filter:blur(1rem);filter:blur(1rem)}.container{padding:0 20px}@media (min-width:0){.container{max-width:auto;margin:0 auto}}@media (min-width:36em){.container{max-width:540px;margin:0 auto}}@media (min-width:48em){.container{max-width:720px;margin:0 auto}}@media (min-width:62em){.container{max-width:960px;margin:0 auto}}@media (min-width:75em){.container{max-width:1170px;margin:0 auto}}.header{background-color:#fff;color:#343851;position:absolute;z-index:4;width:100%;top:0;left:0;will-change:transform;-webkit-transform:translateY(0);transform:translateY(0)}.header a{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}.header__logo{display:-webkit-box;display:-ms-flexbox;display:flex;height:100%;overflow:hidden;padding:19px 0;margin-right:1.25rem;outline:0;color:#313237}.header__logo .header__logo--container{width:58px}.header__logo .header__logo--container .logo{fill:currentColor}.header__inner{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;height:3.75em;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.header__links{padding-bottom:.5rem;display:block;position:absolute;top:3.75em;left:0;width:100%;height:auto;visibility:hidden;background:#fff}.header__link{color:#343851;padding:1em 0;border-top:1px solid #ededed}.header__toggle{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;width:44px;height:100%;background-color:transparent;padding-left:1.25rem}.header__toggle span{display:block;position:relative;margin-top:4px;background-color:#343851;width:100%;height:2px;border-radius:1px}.header__toggle span:first-child{margin-top:0}@media (min-width:62em){.header__toggle{display:none;visibility:hidden}.header__links{position:static;display:-webkit-box;display:-ms-flexbox;display:flex;visibility:visible;width:auto;height:100%}.header__link{position:relative;padding:.938em 0;border:0}.header__link::after{content:"";display:block;position:absolute;left:0;bottom:0;height:3px;width:100%;-webkit-transform:scaleX(0);transform:scaleX(0);background:#277cea}}.post-card{display:block;width:100%;min-height:250px;border-radius:4px;overflow:hidden;background-color:#fff;-webkit-box-shadow:0 1px 3px rgba(0,0,0,.08);box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:5.26316%}@media (min-width:48em){.post-card{width:48.4375%;margin-right:3.125%}.post-card:nth-child(2n+2){margin-right:0}}@media (min-width:75em){.post-card{width:31.25%;margin-right:3.125%}.post-card:nth-child(2n+2){margin-right:3.125%}}.post-card__thumb{margin:0;background:#fff;position:relative;overflow:hidden}.post-card__thumb::after{content:"";display:block;height:0;width:100%;padding-bottom:56.25%}.post-card__thumb>*{position:absolute;top:0;left:0;width:100%;height:100%;display:block}.post-card__inner{padding:1.875rem 1.25rem .625rem;color:#838c8d}.post-card__header{margin-bottom:.75rem}.post-card__header .post-card__meta{font-size:.875rem}.hero{margin:3.75rem auto 0;min-height:16.25rem;width:100%;position:relative;background-color:#dde5ea;background-repeat:no-repeat;background-position:50%;background-size:cover}@media (min-width:62em){.hero{margin:0 auto;height:36em}}.hero::before{position:absolute;display:block;content:"";top:0;left:0;width:100%;height:100%;background:rgba(52,56,81,.8)}.hero__wrap{position:absolute;top:50%;left:50%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);text-align:center;color:rgba(255,255,255,.8);max-width:40em;z-index:1}.hero__wrap .hero__title{color:#fff}.blog{background-color:#f9f9f9}.post-list{padding-top:2.5em;display:-webkit-box;display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-flex:1;-ms-flex:1 0 auto;flex:1 0 auto}@media (min-width:48em){.hero__wrap .hero__title{font-size:2.625em;line-height:3.125rem}.post-list{padding-top:5em}}</style><link rel="preload" href="/assets/css/main.css" as="style" onload="this.rel='stylesheet'"> <noscript><link rel="stylesheet" href="/assets/css/main.css"></noscript> <script type="text/javascript"> /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */ (function(w){"use strict";if(!w.loadCSS){w.loadCSS=function(){}} var rp=loadCSS.relpreload={};rp.support=(function(){var ret;try{ret=w.document.createElement("link").relList.supports("preload")}catch(e){ret=!1} return function(){return ret}})();rp.bindMediaToggle=function(link){var finalMedia=link.media||"all";function enableStylesheet(){link.media=finalMedia} if(link.addEventListener){link.addEventListener("load",enableStylesheet)}else if(link.attachEvent){link.attachEvent("onload",enableStylesheet)} setTimeout(function(){link.rel="stylesheet";link.media="only x"});setTimeout(enableStylesheet,3000)};rp.poly=function(){if(rp.support()){return} var links=w.document.getElementsByTagName("link");for(var i=0;i<links.length;i++){var link=links[i];if(link.rel==="preload"&&link.getAttribute("as")==="style"&&!link.getAttribute("data-loadcss")){link.setAttribute("data-loadcss",!0);rp.bindMediaToggle(link)}}};if(!rp.support()){rp.poly();var run=w.setInterval(rp.poly,500);if(w.addEventListener){w.addEventListener("load",function(){rp.poly();w.clearInterval(run)})}else if(w.attachEvent){w.attachEvent("onload",function(){rp.poly();w.clearInterval(run)})}} if(typeof exports!=="undefined"){exports.loadCSS=loadCSS} else{w.loadCSS=loadCSS}}(typeof global!=="undefined"?global:this)) </script></head><body class="site"><header class="header" itemscope itemtype="http://schema.org/SiteNavigationElement" aria-label="Main navigation"><div class="container"><div class="header__inner"><nav class="header__links"><div class="container header__links-wrapper"> <a class="header__link" href="/" itemprop="url"><span itemprop="name">Home</span></a> <a class="header__link" href="/about" itemprop="url"><span itemprop="name">About</span></a> </a></div></nav><div class="header__toggle"> <span></span> <span></span> <span></span></div></div></div></header><div class="hero lazyload" data-bg="http://localhost:4000/assets/img/posts/unemployment_USA_2016.jpg"><div class="hero__wrap"><h1 class="hero__title">Week 7 - Spatial regression of areal data</h1><p class="hero__meta"> <!-- <span> <time>10 Oct 2017</time>&nbsp; </span>--> <span> </span></p></div></div></div><main class="site__content"><div class="container"><article class="post-content" itemprop="articleBody"><h2 id="week-7---spatial-regression-of-areal-data">Week 7 - spatial regression of areal data</h2><p>You now have the skills to: - map spatial data - obtain, generate and manipulate raster data - conduct spatial interpolation - identify clustering - fit spatial regression models to point prevalence data</p><p>This week are going to introduce 2 more topics.</p><p>1) Modeling count data 2) Fitting spatial models to areal (i.e. polygon) data</p><h2 id="modeling-count-data">Modeling count data</h2><p>The malaria data in Oromia is an example of binomial data. You are also likely to explore count data (e.g. numbers of disease cases). We can use a similar process to model these data. Let’s look at an example of counts recorded over areal units (i.e. polygons). These data contain information on leukemia cases from New York (Turnbull et al 1990). We’ll load in the shape files for New York census tracts and the locations of hazardous waste sites as potential exposures.</p><p>First, load the libraries required for this week</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">rgdal</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">spdep</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">leaflet</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">spaMM</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">viridis</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nydata</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rgdal</span><span class="o">::</span><span class="n">readOGR</span><span class="p">(</span><span class="s2">"https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/course_materials/week7/Lab_files/nydata.geojson"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## OGR data source with driver: GeoJSON 
## Source: "https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/course_materials/week7/Lab_files/nydata.geojson", layer: "nydata"
## with 281 features
## It has 17 fields
</code></pre></div></div><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Let's look at the data</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">nydata</span><span class="o">@</span><span class="n">data</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>##          AREANAME     AREAKEY        X        Y POP8 TRACTCAS  PROPCAS
## 0 Binghamton city 36007000100 4.069397 -67.3533 3540     3.08 0.000870
## 1 Binghamton city 36007000200 4.639371 -66.8619 3560     4.08 0.001146
## 2 Binghamton city 36007000300 5.709063 -66.9775 3739     1.09 0.000292
## 3 Binghamton city 36007000400 7.613831 -65.9958 2784     1.07 0.000384
## 4 Binghamton city 36007000500 7.315968 -67.3183 2571     3.06 0.001190
## 5 Binghamton city 36007000600 8.558753 -66.9344 2729     1.06 0.000388
##   PCTOWNHOME PCTAGE65P        Z  AVGIDIST PEXPOSURE   Cases       Xm
## 0  0.3277311 0.1466102  0.14197 0.2373852  3.167099 3.08284 4069.397
## 1  0.4268293 0.2351124  0.35555 0.2087413  3.038511 4.08331 4639.371
## 2  0.3377396 0.1380048 -0.58165 0.1708548  2.838229 1.08750 5709.063
## 3  0.4616048 0.1188937 -0.29634 0.1406045  2.643366 1.06515 7613.831
## 4  0.1924370 0.1415791  0.45689 0.1577753  2.758587 3.06017 7315.968
## 5  0.3651786 0.1410773 -0.28123 0.1726033  2.848411 1.06386 8558.753
##         Ym   Xshift  Yshift
## 0 -67353.3 423391.0 4661502
## 1 -66861.9 423961.0 4661993
## 2 -66977.5 425030.6 4661878
## 3 -65995.8 426935.4 4662859
## 4 -67318.3 426637.5 4661537
## 5 -66934.4 427880.3 4661921
</code></pre></div></div><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Let's create an incidence column</span><span class="w">
</span><span class="n">nydata</span><span class="o">$</span><span class="n">inc_per_1000</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">nydata</span><span class="o">$</span><span class="n">Cases</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">nydata</span><span class="o">$</span><span class="n">POP8</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span><span class="n">cases_pal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colorBin</span><span class="p">(</span><span class="n">viridis</span><span class="p">(</span><span class="m">4</span><span class="p">),</span><span class="w"> </span><span class="n">bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="p">),</span><span class="w"> </span><span class="n">nydata</span><span class="o">$</span><span class="n">inc_per_1000</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">nydata</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cases_pal</span><span class="p">(</span><span class="n">nydata</span><span class="o">$</span><span class="n">inc_per_1000</span><span class="p">),</span><span class="w"> </span><span class="n">asp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="n">legend</span><span class="p">(</span><span class="s1">'bottomright'</span><span class="p">,</span><span class="w"> </span><span class="n">legend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'0 - 0.1'</span><span class="p">,</span><span class="w"> </span><span class="s1">'0.1 - 0.5'</span><span class="p">,</span><span class="w"> </span><span class="s1">'0.5 - 1'</span><span class="p">,</span><span class="w"> </span><span class="s1">'1 - 8'</span><span class="p">),</span><span class="w">
       </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cases_pal</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="p">)),</span><span class="w">
       </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Cases / 1000'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week7a_spatial_regression_areal_files/figure-gfm/nyc_data-1.png" alt="" /><!-- --></p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># For more info on the dataset type ?spData::nydata</span><span class="w">
</span></code></pre></div></div><p>If we are interested in the relationship between incidence of leukemia and proximity to hazardous waste sites, we can use a regression framework. To model incidence, we will use a Poisson regression which is suitable for modeling count outcomes. As we are more interested in incidence than numbers of cases (i.e. case numbers are in part driven by population), we can include population as an ‘offset’ term which effectively allows us to model rates/incidence. Including population as an offset is kind of like including population as a fixed effect in the background. An offest should be included on the log scale as Poisson regression works in log space. Sometimes, the ‘expected’ counts are used in place of population. These expected counts are typically just a scaled version of population, being the counts you would expect if the mean incidence rate was applied to every areal unit.</p><p>Let’s try fitting a simple model using the covariates <code class="language-plaintext highlighter-rouge">PEXPOSURE</code> which is “exposure potential” calculated as the inverse distance between each census tract centroid and the nearest TCE site.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># First round the case numbers</span><span class="w">
</span><span class="n">nydata</span><span class="o">$</span><span class="n">CASES</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">nydata</span><span class="o">$</span><span class="n">TRACTCAS</span><span class="p">)</span><span class="w">
</span><span class="n">nyc_glm_mod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">glm</span><span class="p">(</span><span class="n">CASES</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">PEXPOSURE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PCTOWNHOME</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PCTAGE65P</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">POP8</span><span class="p">),</span><span class="w"> 
                     </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nydata</span><span class="p">,</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'poisson'</span><span class="p">)</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">nyc_glm_mod</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## 
## Call:
## glm(formula = CASES ~ PEXPOSURE + PCTOWNHOME + PCTAGE65P, family = "poisson", 
##     data = nydata, offset = log(POP8))
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -2.9119  -1.1299  -0.1773   0.6448   3.2443  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept) -8.18147    0.18581 -44.033  &lt; 2e-16 ***
## PEXPOSURE    0.15259    0.03166   4.819 1.44e-06 ***
## PCTOWNHOME  -0.35923    0.19344  -1.857   0.0633 .  
## PCTAGE65P    4.04964    0.60658   6.676 2.45e-11 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 457.66  on 280  degrees of freedom
## Residual deviance: 382.63  on 277  degrees of freedom
## AIC: 957.38
## 
## Number of Fisher Scoring iterations: 5
</code></pre></div></div><p>We can see that ‘PEXPOSURE’ is positively related to incidence, i.e. the further from contamination sites, the lower the risk of leukemia. We can plot fitted versus observed values.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Scatter plot</span><span class="w">
</span><span class="n">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">nyc_glm_mod</span><span class="o">$</span><span class="n">fitted.values</span><span class="p">,</span><span class="w"> </span><span class="n">nydata</span><span class="o">$</span><span class="n">CASES</span><span class="p">))</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week7a_spatial_regression_areal_files/figure-gfm/poisson_validation-1.png" alt="" /><!-- --></p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create maps</span><span class="w">
</span><span class="n">nydata</span><span class="o">$</span><span class="n">fitted</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nyc_glm_mod</span><span class="o">$</span><span class="n">fitted.values</span><span class="w">

</span><span class="n">col_pal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colorNumeric</span><span class="p">(</span><span class="n">topo.colors</span><span class="p">(</span><span class="m">64</span><span class="p">),</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">9</span><span class="p">))</span><span class="w">
</span><span class="n">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">0.8</span><span class="p">,</span><span class="m">4</span><span class="p">)))</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">nydata</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_pal</span><span class="p">(</span><span class="n">nydata</span><span class="o">$</span><span class="n">fitted</span><span class="p">),</span><span class="w"> </span><span class="n">asp</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Fitted'</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">nydata</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_pal</span><span class="p">(</span><span class="n">nydata</span><span class="o">$</span><span class="n">CASES</span><span class="p">),</span><span class="w"> </span><span class="n">asp</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Observed'</span><span class="p">)</span><span class="w">
</span><span class="n">legend</span><span class="p">(</span><span class="s2">"bottomright"</span><span class="p">,</span><span class="w"> </span><span class="n">inset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.2</span><span class="p">,</span><span class="w">
       </span><span class="n">legend</span><span class="o">=</span><span class="m">0</span><span class="o">:</span><span class="m">9</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_pal</span><span class="p">(</span><span class="m">0</span><span class="o">:</span><span class="m">9</span><span class="p">),</span><span class="w">
       </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Counts'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week7a_spatial_regression_areal_files/figure-gfm/poisson_validation-2.png" alt="" /><!-- --></p><p>However, just as covered in week 6, we are making the assumption that the model residuals are independent. In reality, often neighbouring values display some correlation. If present, residual spatial autocorrelation violates the assumption made when applying GLMs. In <a href="">Week 4</a> we covered how to test for spatial autocorrelation (clustering) using a neighbourhood matrix. Such an approach is suitable for areal data where spatial relationships are often better modeled using adjacencies as opposed to distances. We can apply the same approach using our model residuals to test for residual spatial autocorrelation of areal data.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Contiguity neighbors - all that share a boundary point</span><span class="w">
</span><span class="n">nydata_nb</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">poly2nb</span><span class="p">(</span><span class="n">nydata</span><span class="p">)</span><span class="w">  </span><span class="c1">#queen contiguity</span><span class="w">
</span><span class="n">nydata_nb</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Neighbour list object:
## Number of regions: 281 
## Number of nonzero links: 1624 
## Percentage nonzero weights: 2.056712 
## Average number of links: 5.779359
</code></pre></div></div><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># coordinates</span><span class="w">
</span><span class="n">coords</span><span class="o">&lt;-</span><span class="n">coordinates</span><span class="p">(</span><span class="n">nydata</span><span class="p">)</span><span class="w">

</span><span class="c1">#view the neighbors</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">nydata</span><span class="p">,</span><span class="w"> </span><span class="n">asp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">nydata_nb</span><span class="p">,</span><span class="n">coords</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">,</span><span class="n">add</span><span class="o">=</span><span class="nb">T</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week7a_spatial_regression_areal_files/figure-gfm/spatial_dep_test-1.png" alt="" /><!-- --></p><p>Now we have our neighbourhood list, we can run a Conditional Autoregessive (CAR) model, which allows us to incorporate the spatial autocorrelation between neighbours within our GLM. To do this, we are going to stick with the <code class="language-plaintext highlighter-rouge">spaMM</code> package. We first need to convert our neighbourhood list to a neighbourhood (adjacency) matrix which is required by the function. For a CAR model we have to use binary weights (i.e. are you a neighbour 0/1)</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">adj_matrix</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nb2mat</span><span class="p">(</span><span class="n">nydata_nb</span><span class="p">,</span><span class="w"> </span><span class="n">style</span><span class="o">=</span><span class="s2">"B"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><p>The rows and columns of adjMatrix must have names matching those of levels of the random # effect or else be ordered as increasing values of the levels of the geographic location index specifying the spatial random effect. In this case, our census tract ID is <code class="language-plaintext highlighter-rouge">AREAKEY</code> which is ordered as increasing values, so we can remove the rownames of the adjacency matrix. Alternatively, we could set <code class="language-plaintext highlighter-rouge">rownames(adj_matrix) &lt;- colnames(adj_matrix) &lt;- nydata$AREAKEY</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>row.names(adj_matrix) &lt;- NULL
</code></pre></div></div><p>Now we can fit the model. The spatial effect is called using the <code class="language-plaintext highlighter-rouge">adjacency</code> function which requires the grouping factor (i.e. the ID of each census tract).</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Now we can fit the
model

``` r
nyc_car_mod &lt;- fitme(CASES ~ PEXPOSURE + PCTOWNHOME + PCTAGE65P + adjacency(1|AREAKEY) +
                             offset(log(POP8)), 
                     adjMatrix = adj_matrix,
                     data = nydata@data, family = 'poisson')
</code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## If the 'RSpectra' package were installed, an eigenvalue computation could be faster.
</code></pre></div></div><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">summary</span><span class="p">(</span><span class="n">nyc_car_mod</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## formula: CASES ~ PEXPOSURE + PCTOWNHOME + PCTAGE65P + adjacency(1 | AREAKEY) + 
##     offset(log(POP8))
## Estimation of corrPars and lambda by Laplace ML approximation (p_v).
## Estimation of fixed effects by Laplace ML approximation (p_v).
## Estimation of lambda by 'outer' ML, maximizing p_v.
## Family: poisson ( link = log ) 
##  ------------ Fixed effects (beta) ------------
##             Estimate Cond. SE t-value
## (Intercept)  -8.1955  0.20389 -40.195
## PEXPOSURE     0.1510  0.03444   4.386
## PCTOWNHOME   -0.4165  0.21228  -1.962
## PCTAGE65P     4.0803  0.68714   5.938
##  --------------- Random effects ---------------
## Family: gaussian ( link = identity ) 
##                    --- Correlation parameters:
##      1.rho 
## -0.2533568 
##            --- Variance parameters ('lambda'):
## lambda = var(u) for u ~ Gaussian; 
##    AREAKEY  :  0.06657  
## # of obs: 281; # of groups: AREAKEY, 281 
##  ------------- Likelihood values  -------------
##                         logLik
## p_v(h) (marginal L): -471.4893
</code></pre></div></div><p>How has the inclusion of a spatial term affected our estimates? Remeber from week 6, that if you want to generate 95% CIs of your estimates you can use the following code</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">terms</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'PEXPOSURE'</span><span class="p">,</span><span class="w"> </span><span class="s1">'PCTOWNHOME'</span><span class="p">,</span><span class="w"> </span><span class="s1">'PCTAGE65P'</span><span class="p">)</span><span class="w">
</span><span class="n">coefs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">summary</span><span class="p">(</span><span class="n">nyc_car_mod</span><span class="p">)</span><span class="o">$</span><span class="n">beta_table</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## formula: CASES ~ PEXPOSURE + PCTOWNHOME + PCTAGE65P + adjacency(1 | AREAKEY) + 
##     offset(log(POP8))
## Estimation of corrPars and lambda by Laplace ML approximation (p_v).
## Estimation of fixed effects by Laplace ML approximation (p_v).
## Estimation of lambda by 'outer' ML, maximizing p_v.
## Family: poisson ( link = log ) 
##  ------------ Fixed effects (beta) ------------
##             Estimate Cond. SE t-value
## (Intercept)  -8.1955  0.20389 -40.195
## PEXPOSURE     0.1510  0.03444   4.386
## PCTOWNHOME   -0.4165  0.21228  -1.962
## PCTAGE65P     4.0803  0.68714   5.938
##  --------------- Random effects ---------------
## Family: gaussian ( link = identity ) 
##                    --- Correlation parameters:
##      1.rho 
## -0.2533568 
##            --- Variance parameters ('lambda'):
## lambda = var(u) for u ~ Gaussian; 
##    AREAKEY  :  0.06657  
## # of obs: 281; # of groups: AREAKEY, 281 
##  ------------- Likelihood values  -------------
##                         logLik
## p_v(h) (marginal L): -471.4893
</code></pre></div></div><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">row</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">row.names</span><span class="p">(</span><span class="n">coefs</span><span class="p">)</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">terms</span><span class="w">
</span><span class="n">lower</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">coefs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s1">'Estimate'</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1.96</span><span class="o">*</span><span class="n">coefs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="s1">'Cond. SE'</span><span class="p">]</span><span class="w">
</span><span class="n">upper</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">coefs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s1">'Estimate'</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1.96</span><span class="o">*</span><span class="n">coefs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="s1">'Cond. SE'</span><span class="p">]</span><span class="w">
</span><span class="n">data.frame</span><span class="p">(</span><span class="n">terms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">terms</span><span class="p">,</span><span class="w">
           </span><span class="n">IRR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="n">coefs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s1">'Estimate'</span><span class="p">]),</span><span class="w">
           </span><span class="n">lower</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="n">lower</span><span class="p">),</span><span class="w">
           </span><span class="n">upper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="n">upper</span><span class="p">))</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>##        terms        IRR      lower       upper
## 1  PEXPOSURE  1.1630502  1.0871430   1.2442575
## 2 PCTOWNHOME  0.6593296  0.4349178   0.9995348
## 3  PCTAGE65P 59.1607541 15.3859459 227.4799906
</code></pre></div></div><p>We can see how well the model fits using scatter plots and maps</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Scatter plot</span><span class="w">
</span><span class="n">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">fitted</span><span class="p">(</span><span class="n">nyc_car_mod</span><span class="p">),</span><span class="w"> </span><span class="n">nydata</span><span class="o">$</span><span class="n">CASES</span><span class="p">))</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week7a_spatial_regression_areal_files/figure-gfm/car_validation-1.png" alt="" /><!-- --></p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create maps</span><span class="w">
</span><span class="n">nydata</span><span class="o">$</span><span class="n">fitted_car</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fitted</span><span class="p">(</span><span class="n">nyc_car_mod</span><span class="p">)</span><span class="w">

</span><span class="n">col_pal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colorNumeric</span><span class="p">(</span><span class="n">topo.colors</span><span class="p">(</span><span class="m">64</span><span class="p">),</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">9</span><span class="p">))</span><span class="w">
</span><span class="n">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">mar</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">4</span><span class="p">))</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">nydata</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_pal</span><span class="p">(</span><span class="n">nydata</span><span class="o">$</span><span class="n">fitted_car</span><span class="p">),</span><span class="w"> </span><span class="n">asp</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Fitted - CAR'</span><span class="p">)</span><span class="w">
</span><span class="n">legend</span><span class="p">(</span><span class="s2">"bottomright"</span><span class="p">,</span><span class="w"> </span><span class="n">inset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">cex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.8</span><span class="p">,</span><span class="w">
       </span><span class="n">legend</span><span class="o">=</span><span class="m">0</span><span class="o">:</span><span class="m">9</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_pal</span><span class="p">(</span><span class="m">0</span><span class="o">:</span><span class="m">9</span><span class="p">),</span><span class="w">
       </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Counts'</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">nydata</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_pal</span><span class="p">(</span><span class="n">nydata</span><span class="o">$</span><span class="n">CASES</span><span class="p">),</span><span class="w"> </span><span class="n">asp</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Observed'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week7a_spatial_regression_areal_files/figure-gfm/car_validation-2.png" alt="" /><!-- --></p><h3 id="references">References</h3><h4 id="citation-for-the-leukemia-data">Citation for the leukemia data</h4><p>Turnbull, B. W. et al (1990) Monitoring for clusters of disease: application to leukemia incidence in upstate New York American Journal of Epidemiology, 132, 136–143</p><h4 id="key-reading">Key reading</h4><p>Bivand R, Pebesma E, Gomez-Rubio V. (2013). Applied Spatial Data Analysis with R. Use R! Springer: New York (particularly chapter 9 on areal data)</p><h4 id="other-resources">Other resources</h4><p>S. Banerjee, B.P. Carlin and A.E. Gelfand (2003). Hierarchical Modeling and Analysis for Spatial Data. Chapman &amp; Hall.</p><p>D.J. Spiegelhalter, N.G. Best, B.P. Carlin and A. Van der Linde (2002). Bayesian Measures of Model Complexity and Fit (with Discussion), Journal of the Royal Statistical Society, Series B 64(4), 583-616.</p><p>L.A. Waller and C.A. Gotway (2004). Applied Spatial Statistics for Public Health Data. Wiley &amp; Sons.</p></article></div></main><footer class="footer"><div class="container"><nav class="social"></nav><span>&copy; 2022 Applied Spatial Data Science for Public Health. All rights reserved.</span></div></footer><script async src="/assets/js/bundle.js"></script></body></html>
