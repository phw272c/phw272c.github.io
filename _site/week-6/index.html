<html lang="en_US"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --><title>Week 6 - Spatial regression | Applied Spatial Data Science for Public Health</title><meta name="generator" content="Jekyll v3.9.1" /><meta property="og:title" content="Week 6 - Spatial regression" /><meta name="author" content="UC Berkeley School of Public Health" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introduction to spatial regression" /><meta property="og:description" content="Introduction to spatial regression" /><link rel="canonical" href="http://localhost:4000/week-6/" /><meta property="og:url" content="http://localhost:4000/week-6/" /><meta property="og:site_name" content="Applied Spatial Data Science for Public Health" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-10-11T00:00:00-07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Week 6 - Spatial regression" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"UC Berkeley School of Public Health"},"dateModified":"2017-10-11T00:00:00-07:00","datePublished":"2017-10-11T00:00:00-07:00","description":"Introduction to spatial regression","headline":"Week 6 - Spatial regression","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/week-6/"},"url":"http://localhost:4000/week-6/"}</script> <!-- End Jekyll SEO tag --><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/icons/apple-touch-icon.png?v=qA3OXqyw77"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/icons/favicon-32x32.png?v=qA3OXqyw77"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/icons/favicon-16x16.png?v=qA3OXqyw77"><link rel="manifest" href="/assets/img/icons/manifest.json?v=qA3OXqyw77"><link rel="mask-icon" href="/assets/img/icons/safari-pinned-tab.svg?v=qA3OXqyw77" color="#5bbad5"> <!--[if IE]><link rel="shortcut icon" href="/assets/img/icons/favicon.ico?v=qA3OXqyw77"><![endif]--><link rel="shortcut icon" href="/assets/img/icons/favicon.ico?v=qA3OXqyw77"><meta name="apple-mobile-web-app-title" content="Sleek"><meta name="application-name" content="Sleek"><meta name="msapplication-config" content="/assets/img/icons/browserconfig.xml?v=qA3OXqyw77"><meta name="theme-color" content="#ffffff"><style class="inlineCSS"> h1{color:#313237;margin-top:0;margin-bottom:.5rem}.dark-bg{background-color:#313237}@media (min-width:48em){.post-card{width:48.4375%;margin-right:3.125%}.post-card:last-of-type,.post-card:nth-child(2n+2){margin-right:0}}html{line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}header,nav,section{display:block}h1{font-size:2em;margin:.67em 0}figure,main{display:block}figure{margin:1em 40px}a{background-color:transparent;-webkit-text-decoration-skip:objects}img{border-style:none}svg:not(:root){overflow:hidden}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{-webkit-box-sizing:border-box;box-sizing:border-box}body{-webkit-overflow-scrolling:touch}*,::after,::before{-webkit-box-sizing:inherit;box-sizing:inherit}.site{display:-webkit-box;display:-ms-flexbox;display:flex;min-height:100vh;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}.site__content{-webkit-box-flex:1;-ms-flex:1;flex:1}img{max-width:100%;height:auto;width:auto;vertical-align:middle}figure{margin:0}body{background-color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";font-size:1rem;line-height:1.5;color:#343851;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%}p{margin-top:0;margin-bottom:1.25rem}h1,h2{color:#313237;margin-top:0;margin-bottom:.5rem}a{color:#277cea;text-decoration:none}.blur{background:#fff;filter:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg"><filter id="filter"><feGaussianBlur stdDeviation="16" /></filter></svg>#filter');-webkit-filter:blur(1rem);filter:blur(1rem)}.container{padding:0 20px}@media (min-width:0){.container{max-width:auto;margin:0 auto}}@media (min-width:36em){.container{max-width:540px;margin:0 auto}}@media (min-width:48em){.container{max-width:720px;margin:0 auto}}@media (min-width:62em){.container{max-width:960px;margin:0 auto}}@media (min-width:75em){.container{max-width:1170px;margin:0 auto}}.header{background-color:#fff;color:#343851;position:absolute;z-index:4;width:100%;top:0;left:0;will-change:transform;-webkit-transform:translateY(0);transform:translateY(0)}.header a{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}.header__logo{display:-webkit-box;display:-ms-flexbox;display:flex;height:100%;overflow:hidden;padding:19px 0;margin-right:1.25rem;outline:0;color:#313237}.header__logo .header__logo--container{width:58px}.header__logo .header__logo--container .logo{fill:currentColor}.header__inner{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;height:3.75em;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.header__links{padding-bottom:.5rem;display:block;position:absolute;top:3.75em;left:0;width:100%;height:auto;visibility:hidden;background:#fff}.header__link{color:#343851;padding:1em 0;border-top:1px solid #ededed}.header__toggle{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;width:44px;height:100%;background-color:transparent;padding-left:1.25rem}.header__toggle span{display:block;position:relative;margin-top:4px;background-color:#343851;width:100%;height:2px;border-radius:1px}.header__toggle span:first-child{margin-top:0}@media (min-width:62em){.header__toggle{display:none;visibility:hidden}.header__links{position:static;display:-webkit-box;display:-ms-flexbox;display:flex;visibility:visible;width:auto;height:100%}.header__link{position:relative;padding:.938em 0;border:0}.header__link::after{content:"";display:block;position:absolute;left:0;bottom:0;height:3px;width:100%;-webkit-transform:scaleX(0);transform:scaleX(0);background:#277cea}}.post-card{display:block;width:100%;min-height:250px;border-radius:4px;overflow:hidden;background-color:#fff;-webkit-box-shadow:0 1px 3px rgba(0,0,0,.08);box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:5.26316%}@media (min-width:48em){.post-card{width:48.4375%;margin-right:3.125%}.post-card:nth-child(2n+2){margin-right:0}}@media (min-width:75em){.post-card{width:31.25%;margin-right:3.125%}.post-card:nth-child(2n+2){margin-right:3.125%}}.post-card__thumb{margin:0;background:#fff;position:relative;overflow:hidden}.post-card__thumb::after{content:"";display:block;height:0;width:100%;padding-bottom:56.25%}.post-card__thumb>*{position:absolute;top:0;left:0;width:100%;height:100%;display:block}.post-card__inner{padding:1.875rem 1.25rem .625rem;color:#838c8d}.post-card__header{margin-bottom:.75rem}.post-card__header .post-card__meta{font-size:.875rem}.hero{margin:3.75rem auto 0;min-height:16.25rem;width:100%;position:relative;background-color:#dde5ea;background-repeat:no-repeat;background-position:50%;background-size:cover}@media (min-width:62em){.hero{margin:0 auto;height:36em}}.hero::before{position:absolute;display:block;content:"";top:0;left:0;width:100%;height:100%;background:rgba(52,56,81,.8)}.hero__wrap{position:absolute;top:50%;left:50%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);text-align:center;color:rgba(255,255,255,.8);max-width:40em;z-index:1}.hero__wrap .hero__title{color:#fff}.blog{background-color:#f9f9f9}.post-list{padding-top:2.5em;display:-webkit-box;display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-flex:1;-ms-flex:1 0 auto;flex:1 0 auto}@media (min-width:48em){.hero__wrap .hero__title{font-size:2.625em;line-height:3.125rem}.post-list{padding-top:5em}}</style><link rel="preload" href="/assets/css/main.css" as="style" onload="this.rel='stylesheet'"> <noscript><link rel="stylesheet" href="/assets/css/main.css"></noscript> <script type="text/javascript"> /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */ (function(w){"use strict";if(!w.loadCSS){w.loadCSS=function(){}} var rp=loadCSS.relpreload={};rp.support=(function(){var ret;try{ret=w.document.createElement("link").relList.supports("preload")}catch(e){ret=!1} return function(){return ret}})();rp.bindMediaToggle=function(link){var finalMedia=link.media||"all";function enableStylesheet(){link.media=finalMedia} if(link.addEventListener){link.addEventListener("load",enableStylesheet)}else if(link.attachEvent){link.attachEvent("onload",enableStylesheet)} setTimeout(function(){link.rel="stylesheet";link.media="only x"});setTimeout(enableStylesheet,3000)};rp.poly=function(){if(rp.support()){return} var links=w.document.getElementsByTagName("link");for(var i=0;i<links.length;i++){var link=links[i];if(link.rel==="preload"&&link.getAttribute("as")==="style"&&!link.getAttribute("data-loadcss")){link.setAttribute("data-loadcss",!0);rp.bindMediaToggle(link)}}};if(!rp.support()){rp.poly();var run=w.setInterval(rp.poly,500);if(w.addEventListener){w.addEventListener("load",function(){rp.poly();w.clearInterval(run)})}else if(w.attachEvent){w.attachEvent("onload",function(){rp.poly();w.clearInterval(run)})}} if(typeof exports!=="undefined"){exports.loadCSS=loadCSS} else{w.loadCSS=loadCSS}}(typeof global!=="undefined"?global:this)) </script></head><body class="site"><header class="header" itemscope itemtype="http://schema.org/SiteNavigationElement" aria-label="Main navigation"><div class="container"><div class="header__inner"><nav class="header__links"><div class="container header__links-wrapper"> <a class="header__link" href="/" itemprop="url"><span itemprop="name">Home</span></a> <a class="header__link" href="/about" itemprop="url"><span itemprop="name">About</span></a> </a></div></nav><div class="header__toggle"> <span></span> <span></span> <span></span></div></div></div></header><div class="hero lazyload" data-bg="http://localhost:4000/assets/img/posts/risk_oromia.jpg"><div class="hero__wrap"><h1 class="hero__title">Week 6 - Spatial regression</h1><p class="hero__meta"> <!-- <span> <time>11 Oct 2017</time>&nbsp; </span>--> <span> </span></p></div></div></div><main class="site__content"><div class="container"><article class="post-content" itemprop="articleBody"><h1 id="introduction-to-spatial-regression">Introduction to spatial regression</h1><h2 id="week-6---spatial-regression">Week 6 - spatial regression</h2><p>You now have the skills to:</p><ul><li>map spatial data</li><li>obtain, generate and manipulate raster data</li><li>conduct spatial interpolation</li><li>identify clustering</li></ul><p>This week, and in coming weeks, we are going to start putting these concepts together as part of regression analyses. Regression analyses allow us to look for associations between our outcome of interest (e.g. prevalence of infection, incidence of disease etc.) and a set of predictors.</p><h3 id="univariate-linear-model">Univariate Linear Model</h3><p>As a first step we will do a recap on a <em>linear regression model</em>. In this problem we have a set of measurments of two variables, say (X) and (Y), and we try to explain the values of our continuous outcome (Y) based on the values on (X). To do this we find the line that is the closest to all the points ((x, y)).</p><p>Besides the code displayed here, we will use some additional code to generate some toy datasets that will help illustrate the exposition. Before starting we will load these code as well as the other required libraries, including ggplot2 which will be used for creating most of the images displayed.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Loading required package: sp
</code></pre></div></div><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">ModelMetrics</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## 
## Attaching package: 'ModelMetrics'

## The following object is masked from 'package:base':
## 
##     kappa
</code></pre></div></div><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">spaMM</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## spaMM (version 3.0.0) is loaded.
## Type 'help(spaMM)' for a short introduction,
## and news(package='spaMM') for news.
</code></pre></div></div><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">source</span><span class="p">(</span><span class="s2">"https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/course_materials/week6/Lab_files/R%20Files/background_functions.R"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><p>The command below generates a toy dataset that we will use as an example.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Generate example data</span><span class="w">
</span><span class="n">dset1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">univariate_lm</span><span class="p">()</span><span class="w">

</span><span class="c1"># Show data</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">dset1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>##             x         y
## 1 -0.38813740 -8.005137
## 2  0.01616137 -7.917746
## 3  0.40175907 -7.892104
## 4  0.54888497 -8.061714
## 5  0.97495187 -7.694279
## 6  1.05565842 -7.741698
</code></pre></div></div><p>In <em>R</em> we can fit a linear model and make predictions with the comands shown next.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Fit linear model on dataset 1</span><span class="w">
</span><span class="n">m1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lm</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dset1</span><span class="p">)</span><span class="w">
</span><span class="n">m1_pred</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dset1</span><span class="p">,</span><span class="w"> </span><span class="n">interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"confidence"</span><span class="p">)</span><span class="w">
</span><span class="n">dset1</span><span class="o">$</span><span class="n">y_hat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">m1_pred</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span><span class="w">
</span><span class="n">dset1</span><span class="o">$</span><span class="n">y_lwr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">m1_pred</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span><span class="w">
</span><span class="n">dset1</span><span class="o">$</span><span class="n">y_upr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">m1_pred</span><span class="p">[,</span><span class="m">3</span><span class="p">]</span><span class="w">

</span><span class="c1"># plot</span><span class="w">
</span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dset1</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_point</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s2">"steelblue"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y_hat</span><span class="p">),</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_ribbon</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="n">y_lwr</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="o">=</span><span class="n">y_upr</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="s2">"magenta"</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">.25</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w"> 
        </span><span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week6a_intro_spatial_regression_files/figure-gfm/plt_lm-1.png" alt="" /><!-- --></p><h3 id="univariate-glm">Univariate GLM</h3><p>While very useful, it is common that the model above turns out to be a not good assumption. Think of the case where (Y) is constrained to be positive. A straight line, unless it is horizontal, will cross the (y)-axis at some point. If the values of (X) where (Y) becomes negative are rare or they are a set of values we are not interested in, we may simply ignore them, however there are scenarios where we cannot afford having impossible values for (Y).</p><p>As an example, we will load a second toy dataset where the outcome (Y) is prevalence of infection (expressed as a probability) and fit a liner regression model. Look at the bottom left corner of figure below. The predictions of (Y) are starting to cross the zero value and become negative, but the observed data remain positive.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Fit linear model on dataset 2</span><span class="w">
</span><span class="n">dset2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">univariate_glm</span><span class="p">()</span><span class="w">
</span><span class="n">m2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lm</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dset2</span><span class="p">)</span><span class="w">
</span><span class="n">m2_pred</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dset1</span><span class="p">,</span><span class="w"> </span><span class="n">interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"confidence"</span><span class="p">)</span><span class="w">
</span><span class="n">dset2</span><span class="o">$</span><span class="n">y_hat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">m2_pred</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span><span class="w">
</span><span class="n">dset2</span><span class="o">$</span><span class="n">y_lwr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">m2_pred</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span><span class="w">
</span><span class="n">dset2</span><span class="o">$</span><span class="n">y_upr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">m2_pred</span><span class="p">[,</span><span class="m">3</span><span class="p">]</span><span class="w">

</span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">subset</span><span class="p">(</span><span class="n">dset2</span><span class="p">),</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_point</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s2">"steelblue"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y_hat</span><span class="p">),</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_ribbon</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="n">y_lwr</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="o">=</span><span class="n">y_upr</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="s2">"magenta"</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">.25</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w"> 
        </span><span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week6a_intro_spatial_regression_files/figure-gfm/glm-1.png" alt="" /><!-- --></p><p>A solution to this problem is to use <em>generalized linear models</em> (GLM). A GLM uses a transformation on (Y) where the assumptions of the standard linear regression are valid (figure below), then it goes back to the original scale of (Y) and makes predictions. For example, as our outcome is a probability, we can use the common ‘logit’ transformation, also known as log odds, calculated as log(p/(1-p)) where p is the probability of infection. <img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week6a_intro_spatial_regression_files/figure-gfm/plt_logit-1.png" alt="" /><!-- --></p><p>When fitting a GLM to the dataset shown in the second example above, the resulting predictions draw a curve that never reaches zero. <img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week6a_intro_spatial_regression_files/figure-gfm/glm_quasibinomial-1.png" alt="" /><!-- --></p><p>Similarly, we can use the GLM framework to model other non-continuous outcomes. These include binary outcomes (i.e. 0 and 1), multi-class outcomes (e.g. ‘A’, ‘B’ and ‘C’) and counts (e.g. numbers of cases). Here we are going to do a deep dive on binary and counts outcomes as these are likely to be the most common types of outcomes you will deal with.</p><p>For the binary case, we are going to use the Ethiopia malaria data. While the outcome of interest here is prevalence, prevalence is just an aggregate of the numbers of 1s and 0s at each location. In this instance we can use what’s called a logistic regression as our data are binomial (numbers positive out of a number examined). Logistic regression works with the logit transformation.</p><p>As a reminder, this survey data contains information about number of positive cases and number of examined people in different schools. Spatial information is encoded in the fields <em>longitude</em> and <em>latitude</em>.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load data</span><span class="w">
</span><span class="n">ETH_malaria_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/course_materials/week1/Lab_files/Data/mal_data_eth_2009_no_dups.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="nb">T</span><span class="p">)</span><span class="w"> </span><span class="c1"># Case data</span><span class="w">
</span><span class="n">ETH_Adm_1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">raster</span><span class="o">::</span><span class="n">getData</span><span class="p">(</span><span class="s2">"GADM"</span><span class="p">,</span><span class="w"> </span><span class="n">country</span><span class="o">=</span><span class="s2">"ETH"</span><span class="p">,</span><span class="w"> </span><span class="n">level</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="c1"># Admin boundaries</span><span class="w">
</span><span class="n">Oromia</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">ETH_Adm_1</span><span class="p">,</span><span class="w"> </span><span class="n">NAME_1</span><span class="o">==</span><span class="s2">"Oromia"</span><span class="p">)</span><span class="w">
</span><span class="c1"># Plot both country and data points</span><span class="w">
</span><span class="n">raster</span><span class="o">::</span><span class="n">plot</span><span class="p">(</span><span class="n">Oromia</span><span class="p">)</span><span class="w">
</span><span class="n">points</span><span class="p">(</span><span class="n">ETH_malaria_data</span><span class="o">$</span><span class="n">longitude</span><span class="p">,</span><span class="w"> </span><span class="n">ETH_malaria_data</span><span class="o">$</span><span class="n">latitude</span><span class="p">,</span><span class="w">
       </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Latitude"</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="o">=</span><span class="s2">"Longitude"</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span><span class="w"> </span><span class="n">cex</span><span class="o">=</span><span class="m">.5</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week6a_intro_spatial_regression_files/figure-gfm/ETH_malaria_data_data-1.png" alt="" /><!-- --></p><p>To model and predict malaria prevalence across Oromia State, we need to first obtain predictors as rasters at a common resolution/extent. In this example, we are going to use two of the <a href="https://www.worldclim.org/bioclim">Bioclim</a> layers, accessible using the <code class="language-plaintext highlighter-rouge">getData</code> function in the raster package.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bioclim_layers</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">raster</span><span class="o">::</span><span class="n">getData</span><span class="p">(</span><span class="s1">'worldclim'</span><span class="p">,</span><span class="w"> </span><span class="n">var</span><span class="o">=</span><span class="s1">'bio'</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="o">=</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="o">=</span><span class="m">38.7578</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="o">=</span><span class="m">8.9806</span><span class="p">)</span><span class="w"> </span><span class="c1"># lng/lat for Addis Ababa</span><span class="w">
</span></code></pre></div></div><p>We can crop these layers to make them a little easier to handle</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bioclim_layers_oromia</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">crop</span><span class="p">(</span><span class="n">bioclim_layers</span><span class="p">,</span><span class="w"> </span><span class="n">Oromia</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">bioclim_layers_oromia</span><span class="p">[[</span><span class="m">1</span><span class="p">]])</span><span class="w"> </span><span class="c1"># Bio1 - Annual mean temperature</span><span class="w">
</span><span class="n">lines</span><span class="p">(</span><span class="n">Oromia</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week6a_intro_spatial_regression_files/figure-gfm/unnamed-chunk-2-1.png" alt="" /><!-- --></p><p>Now let’s extract Bio1 (Annual mean temperature) and Bio2 (Mean Diurnal Range (Mean of monthly (max temp - min temp))) at the observation points</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ETH_malaria_data</span><span class="o">$</span><span class="n">bioclim1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">extract</span><span class="p">(</span><span class="n">bioclim_layers_oromia</span><span class="p">[[</span><span class="m">1</span><span class="p">]],</span><span class="w"> </span><span class="n">ETH_malaria_data</span><span class="p">[,</span><span class="nf">c</span><span class="p">(</span><span class="s2">"longitude"</span><span class="p">,</span><span class="w"> </span><span class="s2">"latitude"</span><span class="p">)])</span><span class="w">
</span><span class="n">ETH_malaria_data</span><span class="o">$</span><span class="n">bioclim2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">extract</span><span class="p">(</span><span class="n">bioclim_layers_oromia</span><span class="p">[[</span><span class="m">2</span><span class="p">]],</span><span class="w"> </span><span class="n">ETH_malaria_data</span><span class="p">[,</span><span class="nf">c</span><span class="p">(</span><span class="s2">"longitude"</span><span class="p">,</span><span class="w"> </span><span class="s2">"latitude"</span><span class="p">)])</span><span class="w">
</span></code></pre></div></div><p>Now we fit the model. In the binomial case, it is possible to have a 2 columned matrix as the outcome representing numbers positive and numbers negative. Our outcome could also be a set of 0s and 1s if we had individual level data.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">glm_mod_1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">glm</span><span class="p">(</span><span class="n">cbind</span><span class="p">(</span><span class="n">pf_pos</span><span class="p">,</span><span class="w"> </span><span class="n">examined</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pf_pos</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">bioclim1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bioclim2</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">ETH_malaria_data</span><span class="p">,</span><span class="w"> </span><span class="n">family</span><span class="o">=</span><span class="n">binomial</span><span class="p">())</span><span class="w">
</span></code></pre></div></div><p>Now let’s take a look at the model output:</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">summary</span><span class="p">(</span><span class="n">glm_mod_1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## 
## Call:
## glm(formula = cbind(pf_pos, examined - pf_pos) ~ bioclim1 + bioclim2, 
##     family = binomial(), data = ETH_malaria_data)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.4327  -0.9205  -0.7473  -0.5879   7.6321  
## 
## Coefficients:
##               Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept) -13.717021   2.189372  -6.265 3.72e-10 ***
## bioclim1      0.008466   0.006164   1.374 0.169577    
## bioclim2      0.044857   0.012550   3.574 0.000351 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 383.42  on 202  degrees of freedom
## Residual deviance: 368.12  on 200  degrees of freedom
## AIC: 444.27
## 
## Number of Fisher Scoring iterations: 6
</code></pre></div></div><p>The <code class="language-plaintext highlighter-rouge">Deviance Residuals:</code> shows us the variation in how far away our observations are from the predicted values. Observations with a deviance residual in excess of two may indicate lack of fit.</p><p>The <code class="language-plaintext highlighter-rouge">Coefficients</code> show us the slope of the line fit for each predictor which tells us something about the direction of the association. Positive coefficients suggest a positive relationship and negative a negative relationship. These are all expressed on the log scale as we are working in logit space. The standard error and z values are used to calculate the p-value which tells us how likely this relationship was observed by chance. If you want to express your coefficients as odds ratios, you can exponentiate these values. E.g. the estimate for bioclim 1 is is 0.008466 which is an odds ratio of 1.009.</p><p>The <code class="language-plaintext highlighter-rouge">Null deviance</code> tells us how well a model only with the intercept (i.e. if you assume the mean at every location) fits the data. <code class="language-plaintext highlighter-rouge">Residual deviance</code> tells us how well the model with the predictors fits the data. Lower values (i.e. less deviation of the predicted value from the observed) is better.</p><p>In this case, it looks like there is no evidence that bioclim1 is related to prevalence but bioclim2 is. Let’s try re-running the model without bioclim 1.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">glm_mod_2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">glm</span><span class="p">(</span><span class="n">cbind</span><span class="p">(</span><span class="n">pf_pos</span><span class="p">,</span><span class="w"> </span><span class="n">examined</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pf_pos</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">bioclim2</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">ETH_malaria_data</span><span class="p">,</span><span class="w"> </span><span class="n">family</span><span class="o">=</span><span class="n">binomial</span><span class="p">())</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">glm_mod_2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## 
## Call:
## glm(formula = cbind(pf_pos, examined - pf_pos) ~ bioclim2, family = binomial(), 
##     data = ETH_malaria_data)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.3321  -0.9212  -0.7507  -0.6068   7.5499  
## 
## Coefficients:
##              Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept) -11.97128    1.78167  -6.719 1.83e-11 ***
## bioclim2      0.04455    0.01254   3.554 0.000379 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 383.42  on 202  degrees of freedom
## Residual deviance: 369.98  on 201  degrees of freedom
## AIC: 444.12
## 
## Number of Fisher Scoring iterations: 6
</code></pre></div></div><p>OK the estimate for bioclim2 is 0.04455 which is an odds ratio of 1.05. This means that for every unit increase in mean diurnal range, the odds of infection increase by 5%.</p><p>It is possible to explore associations with other sensible covariates in the same way, i.e. by including them in the model and seeing which are ‘significant’. This kind of forward stepwise method to select variables is only 1 way to build a model. Some advocate using AIC or cross-validation techniques which we will introduce later.</p><p>It is also useful to check how well your fitted values (i.e. predictions at your data points) line up with the observations.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">glm_mod_2</span><span class="o">$</span><span class="n">fitted</span><span class="p">,</span><span class="w"> </span><span class="n">ETH_malaria_data</span><span class="o">$</span><span class="n">pf_pr</span><span class="p">))</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week6a_intro_spatial_regression_files/figure-gfm/fitted_v_observed-1.png" alt="" /><!-- --></p><p>Our fitted values don’t line up particularly well with the observed data, suggesting that bioclim2 alone doesn’t explain prevalence very well.</p><p>Once you have a final model you are happy with, it is now possible to predict prevalence at all other locations using the model covariates. In this case, we have a model with only bioclim2. Let’s assume this is our final model and make predictions using this variable.</p><p>As we only have 1 covariate, there is no need to worry about resampling rasters. If you are using multiple covariates, you should ensure these are resampled to the same grid (extent and resolution) before extracting and modeling. As a reminder, <a href="https://github.com/HughSt/HughSt.github.io/blob/master/_posts/raster_resampling.md">here</a> is a walkthrough of resmapling.</p><p>If you want to predict using a model, you have to provide a data.frame of observations (points) with the same variables used in the model. If you want to produce a risk map, i.e. predict prevalence over a grid, instead of providing a data.frame, the <code class="language-plaintext highlighter-rouge">raster</code> package allows you to predict using a model and a raster (layer or stack if multiple layers). Let’s try both.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Make a prediction at a single location</span><span class="w">
</span><span class="c1"># with a bioclim2 value of 120</span><span class="w">
</span><span class="n">prediction_point</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">bioclim2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">120</span><span class="p">)</span><span class="w">

</span><span class="c1"># Now predict. Using type='response' tells R you want </span><span class="w">
</span><span class="c1"># predictions on the probability scale instead of </span><span class="w">
</span><span class="c1"># log odds</span><span class="w">
</span><span class="n">predict</span><span class="p">(</span><span class="n">glm_mod_2</span><span class="p">,</span><span class="w"> </span><span class="n">prediction_point</span><span class="p">,</span><span class="w">  </span><span class="n">type</span><span class="o">=</span><span class="s2">"response"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>##          1 
## 0.00132496
</code></pre></div></div><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Now let's predict over the whole raster. We first have to </span><span class="w">
</span><span class="c1"># make sure that the raster layer(s) pf the covariates</span><span class="w">
</span><span class="c1"># we want to use to predict have the same name</span><span class="w">
</span><span class="c1"># as that used in the model (i.e. 'bioclim2')</span><span class="w">
</span><span class="n">pred_raster</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">bioclim_layers_oromia</span><span class="p">[[</span><span class="m">2</span><span class="p">]]</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">pred_raster</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'bioclim2'</span><span class="w">

</span><span class="c1"># Now as we are predicting using a raster, we specify the</span><span class="w">
</span><span class="c1"># raster first, then the model</span><span class="w">
</span><span class="n">predicted_risk</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">pred_raster</span><span class="p">,</span><span class="w">
                          </span><span class="n">glm_mod_2</span><span class="p">,</span><span class="w">
                          </span><span class="n">type</span><span class="o">=</span><span class="s1">'response'</span><span class="p">)</span><span class="w">

</span><span class="c1"># Now plot</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">predicted_risk</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week6a_intro_spatial_regression_files/figure-gfm/prediction-1.png" alt="" /><!-- --></p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># or masked to Oromia</span><span class="w">
</span><span class="n">predicted_risk_masked</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mask</span><span class="p">(</span><span class="n">predicted_risk</span><span class="p">,</span><span class="w"> </span><span class="n">Oromia</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">predicted_risk_masked</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week6a_intro_spatial_regression_files/figure-gfm/prediction-2.png" alt="" /><!-- --></p><p>One of the assumptions we make when fitting GLMs is that the residuals of the model (i.e. what isn’t explained by the covairates) are independent. Often, however, with spatial data this assumption isn’t met. Neighboring values are often correlated with each other. This raises 2 questions:</p><h4 id="1-how-do-you-know-whether-there-is-any-residual-spatial-autocorrelation">1) How do you know whether there is any residual spatial autocorrelation?</h4><p>If there is no residual spatial autocorrelation, then we can trust the regression estimates. To test whether the residuals are independent, we can use Moran’s coefficient (as introduced in <a href="https://hughst.github.io/week-4/">Week 4</a>. The table and spatial autocorrelogram below suggest that there is spatial autocorrelation up to scales of ~1.2 decimal degress and therefore that the residuals are not independent.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compute correlogram of the residuals</span><span class="w">
</span><span class="n">nbc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="n">cor_r</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pgirmess</span><span class="o">::</span><span class="n">correlog</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">ETH_malaria_data</span><span class="p">[,</span><span class="nf">c</span><span class="p">(</span><span class="s2">"longitude"</span><span class="p">,</span><span class="w"> </span><span class="s2">"latitude"</span><span class="p">)],</span><span class="w">
                            </span><span class="n">z</span><span class="o">=</span><span class="n">glm_mod_2</span><span class="o">$</span><span class="n">residuals</span><span class="p">,</span><span class="w">
                            </span><span class="n">method</span><span class="o">=</span><span class="s2">"Moran"</span><span class="p">,</span><span class="w"> </span><span class="n">nbclass</span><span class="o">=</span><span class="n">nbc</span><span class="p">)</span><span class="w">

</span><span class="n">cor_r</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Moran I statistic 
##       dist.class         coef      p.value    n
##  [1,]  0.3979675  0.139537758 1.452043e-14 3904
##  [2,]  1.1937029  0.027455904 1.132424e-02 5192
##  [3,]  1.9894379 -0.015590957 7.771255e-01 5680
##  [4,]  2.7851728  0.021688238 4.436913e-02 4976
##  [5,]  3.5809077 -0.029494019 9.462506e-01 5078
##  [6,]  4.3766427 -0.037610752 9.943232e-01 5896
##  [7,]  5.1723776 -0.021069731 8.480308e-01 4890
##  [8,]  5.9681126 -0.009427237 5.663123e-01 3694
##  [9,]  6.7638475 -0.006745678 4.501948e-01 1412
## [10,]  7.5595825 -0.019553283 4.527890e-01  284
</code></pre></div></div><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">correlograms</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">cor_r</span><span class="p">)</span><span class="w">
</span><span class="n">correlograms</span><span class="o">$</span><span class="n">variable</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"residuals_glm"</span><span class="w"> 

</span><span class="c1"># Plot correlogram</span><span class="w">
</span><span class="n">ggplot</span><span class="p">(</span><span class="n">subset</span><span class="p">(</span><span class="n">correlograms</span><span class="p">,</span><span class="w"> </span><span class="n">variable</span><span class="o">==</span><span class="s2">"residuals_glm"</span><span class="p">),</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">dist.class</span><span class="p">,</span><span class="w"> </span><span class="n">coef</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_hline</span><span class="p">(</span><span class="n">yintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="s2">"grey"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s2">"steelblue"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_point</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s2">"steelblue"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"distance"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">ylab</span><span class="p">(</span><span class="s2">"Moran's coefficient"</span><span class="p">)</span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w"> 
        </span><span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w"> </span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_line</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week6a_intro_spatial_regression_files/figure-gfm/unnamed-chunk-6-1.png" alt="" /><!-- --></p><p>OK, so we’ve established that our model violates the assumptions of a GLM. This leads to the next question</p><h4 id="2-if-residual-spatial-autocorrelation-is-present-what-can-we-do-about-it">2) If residual spatial autocorrelation is present, what can we do about it?</h4><p>As introduced in <a href="https://hughst.github.io/week-3/">Week 3</a>, the core idea behind Spatial Statistics is to understand and characterize this spatial dependence that is observed in different processes, for example: amount of rainfall, global temperature, air pollution, etc. Spatial Statistics deal with problems where neighbouring values are expected to be more alike than things further apart from each other.</p><p>When we want to measure how much two variables change together, we use the covariance function. Covariance functions are effectively the same as the variogram models you explored in <a href="https://hughst.github.io/week-3/">Week 3</a> and are used to estimate the similarity between values in space as a function of the distance between them. Under the right assumptions, we can also use the covariance function to describe the similarity of the observed values based on their location.</p><p>A covariance function <em>K</em> : 𝕊 × 𝕊 → ℝ maps a pair of points <em>z</em><sub>1</sub> = (<em>s</em><sub>[1, 1]</sub>, <em>s</em><sub>[1, 2]</sub>) and <em>z</em><sub>2</sub> = (<em>s</em><sub>[2, 1]</sub>, <em>s</em><sub>[2, 2]</sub>) to the real line. We can define such a function in terms of the distance between a pair of points. Let the distance between the points be given by <em>r</em> = ∥<em>z</em><sub>1</sub> − <em>z</em><sub>2</sub>∥, the following are examples of covarinace functions:</p><p>Exponentiated Quadratic: <em>K</em>(<em>z</em><sub>1</sub>, <em>z</em><sub>2</sub>)=<em>σ</em><sup>2</sup>exp(−<em>r</em><sup>2</sup>/<em>ρ</em><sup>2</sup>)</p><p>Rational Quadratic: <em>K</em>(<em>z</em><sub>1</sub>, <em>z</em><sub>2</sub>)=<em>σ</em><sup>2</sup>(1 + <em>r</em><sup>2</sup>/(2<em>αρ</em><sup>2</sup>))<sup>−<em>α</em></sup></p><p>Matern Covariance: <em>K</em>(<em>z</em><sub>1</sub>, <em>z</em><sub>2</sub>)=<em>σ</em><sup>2</sup>2<sup>1 − <em>ν</em></sup>/<em>Γ</em>(<em>ν</em>)((2<em>ν</em>)<sup>.5</sup><em>r</em>/<em>ρ</em>)<sup><em>ν</em></sup>𝒦<sub><em>ν</em></sub>((2<em>ν</em>)<sup>.5</sup><em>r</em>/<em>ρ</em>)</p><p>Here, nu (<em>ν</em>) represents the ‘smoothness’ parameter, alpha <em>α</em> determines the relative weighting of large-scale and small-scale variations, rho (<em>ρ</em>) the scale parameter, <em>Γ</em> is the gamma function and 𝒦<sub><em>ν</em></sub> is the modified Bessel function of second kind. In the three cases, while less clear in the Matern case, the covariance decreases asymptotically towards zero the larger the value of <em>r</em>. This means that the more distance between a pair of points, the weaker the covariance between them.</p><p>The election of which covariance function to use depends on our assumptions about the change in the association between the points across space (eg., the speed of decay).</p><h2 id="geostatistics">Geostatistics</h2><p>Now that we have discussed how the covariance function can help model spatial dependence, we can discuss how to incorporate this ideas into our model. In our GLM example above we fitted a model of the form</p><p><em>η</em><sub><em>i</em></sub> = <em>β</em><sub>0</sub> + <em>β</em><sub>1</sub><em>x</em><sub><em>i</em></sub> + <em>e</em><sub><em>i</em></sub>,</p><p>Now we will incorporate an spatially correlated random effect (<em>b</em><sub><em>i</em></sub>):</p><p><em>η</em><sub><em>i</em></sub> = <em>β</em><sub>0</sub> + <em>β</em><sub>1</sub><em>x</em><sub><em>i</em></sub> + <em>e</em><sub><em>i</em></sub> + <em>b</em><sub><em>i</em></sub> where spatial correlation is modeled using a covariance function <em>K</em>.</p><p>We can implement this model, assuming a Matern covariance, as shown below.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">glm_mod_2_spatial</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">spaMM</span><span class="o">::</span><span class="n">fitme</span><span class="p">(</span><span class="n">cbind</span><span class="p">(</span><span class="n">pf_pos</span><span class="p">,</span><span class="w"> </span><span class="n">examined</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pf_pos</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">bioclim2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Matern</span><span class="p">(</span><span class="m">1</span><span class="o">|</span><span class="n">latitude</span><span class="o">+</span><span class="n">longitude</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">ETH_malaria_data</span><span class="p">,</span><span class="w"> </span><span class="n">family</span><span class="o">=</span><span class="n">binomial</span><span class="p">())</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">glm_mod_2_spatial</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## formula: cbind(pf_pos, examined - pf_pos) ~ bioclim2 + Matern(1 | latitude + 
##     longitude)
## Estimation of corrPars and lambda by Laplace ML approximation (p_v).
## Estimation of fixed effects by Laplace ML approximation (p_v).
## Estimation of lambda by 'outer' ML, maximizing p_v.
## Family: binomial ( link = logit ) 
##  ------------ Fixed effects (beta) ------------
##             Estimate Cond. SE t-value
## (Intercept) -9.84455  5.61006 -1.7548
## bioclim2     0.01136  0.04051  0.2803
##  --------------- Random effects ---------------
## Family: gaussian ( link = identity ) 
##                    --- Correlation parameters:
##      1.nu     1.rho 
## 0.4695574 2.4472962 
##            --- Variance parameters ('lambda'):
## lambda = var(u) for u ~ Gaussian; 
##    latitude .  :  4.845  
## # of obs: 203; # of groups: latitude ., 203 
##  ------------- Likelihood values  -------------
##                         logLik
## p_v(h) (marginal L): -107.5769
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">nu</code> (<em>ν</em>) represents the ‘smoothness’ parameter and <code class="language-plaintext highlighter-rouge">rho</code> (<em>ρ</em>) the scale parameter. <code class="language-plaintext highlighter-rouge">lambda</code> is the estimated variance in the random effect and <code class="language-plaintext highlighter-rouge">phi</code> the estimated variance in the residual error.</p><p>You can see that the estimate for the effect of bioclim2 has dropped towards 0. While <code class="language-plaintext highlighter-rouge">spaMM</code> doesn’t provide p-values, you can calculate the 95% confidence intervals as follows.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">coefs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">summary</span><span class="p">(</span><span class="n">glm_mod_2_spatial</span><span class="p">)</span><span class="o">$</span><span class="n">beta_table</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## formula: cbind(pf_pos, examined - pf_pos) ~ bioclim2 + Matern(1 | latitude + 
##     longitude)
## Estimation of corrPars and lambda by Laplace ML approximation (p_v).
## Estimation of fixed effects by Laplace ML approximation (p_v).
## Estimation of lambda by 'outer' ML, maximizing p_v.
## Family: binomial ( link = logit ) 
##  ------------ Fixed effects (beta) ------------
##             Estimate Cond. SE t-value
## (Intercept) -9.84455  5.61006 -1.7548
## bioclim2     0.01136  0.04051  0.2803
##  --------------- Random effects ---------------
## Family: gaussian ( link = identity ) 
##                    --- Correlation parameters:
##      1.nu     1.rho 
## 0.4695574 2.4472962 
##            --- Variance parameters ('lambda'):
## lambda = var(u) for u ~ Gaussian; 
##    latitude .  :  4.845  
## # of obs: 203; # of groups: latitude ., 203 
##  ------------- Likelihood values  -------------
##                         logLik
## p_v(h) (marginal L): -107.5769
</code></pre></div></div><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">row</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">row.names</span><span class="p">(</span><span class="n">coefs</span><span class="p">)</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'bioclim2'</span><span class="p">)</span><span class="w">
</span><span class="n">lower</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">coefs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s1">'Estimate'</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1.96</span><span class="o">*</span><span class="n">coefs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="s1">'Cond. SE'</span><span class="p">]</span><span class="w">
</span><span class="n">upper</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">coefs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="s1">'Estimate'</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1.96</span><span class="o">*</span><span class="n">coefs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="s1">'Cond. SE'</span><span class="p">]</span><span class="w">
</span><span class="nf">c</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span><span class="w"> </span><span class="n">upper</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] -0.06803875  0.09074934
</code></pre></div></div><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># If you want to express as an odds ratio</span><span class="w">
</span><span class="n">OR</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span><span class="w"> </span><span class="n">upper</span><span class="p">))</span><span class="w">
</span></code></pre></div></div><p>Which shows that having accounted for spatial autocorrelation, there is no evidence that ‘Bioclim2’ is associated with malaria prevalence.</p><p>We can also re-test for residual spatial autocorrelation to make sure that this is removed by our spatial model as specified.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compute correlogram of the residuals</span><span class="w">
</span><span class="n">nbc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="n">cor_r</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pgirmess</span><span class="o">::</span><span class="n">correlog</span><span class="p">(</span><span class="n">coords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ETH_malaria_data</span><span class="p">[,</span><span class="nf">c</span><span class="p">(</span><span class="s2">"longitude"</span><span class="p">,</span><span class="w"> </span><span class="s2">"latitude"</span><span class="p">)],</span><span class="w">
                            </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">residuals</span><span class="p">(</span><span class="n">glm_mod_2_spatial</span><span class="p">),</span><span class="w">
                            </span><span class="n">method</span><span class="o">=</span><span class="s2">"Moran"</span><span class="p">,</span><span class="w"> </span><span class="n">nbclass</span><span class="o">=</span><span class="n">nbc</span><span class="p">)</span><span class="w">
</span><span class="n">cor_r</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Moran I statistic 
##       dist.class         coef   p.value    n
##  [1,]  0.3979675 -0.082103557 0.9982340 3904
##  [2,]  1.1937029 -0.004771094 0.4963582 5192
##  [3,]  1.9894379 -0.010640882 0.6170209 5680
##  [4,]  2.7851728  0.005227741 0.3144509 4976
##  [5,]  3.5809077 -0.007276726 0.5446715 5078
##  [6,]  4.3766427  0.007878155 0.2362530 5896
##  [7,]  5.1723776 -0.010644341 0.5983817 4890
##  [8,]  5.9681126  0.010933890 0.2718782 3694
##  [9,]  6.7638475 -0.009638177 0.4949906 1412
## [10,]  7.5595825 -0.007011994 0.3814165  284
</code></pre></div></div><h3 id="prediction">Prediction</h3><p>Once you have a model that relates our climatic (or other spatial) layers to prevalence, we can predict the probability/prevalence of infection at any location within the region our data are representative where we have values of these climatic layers. For the purpose of demonstration, we are going to assume that bioclim2 is related to prevalence and will therefore be used to make predictions. It is possible to predict from a model directly onto a raster stack of covariates which makes life easy. However, in this case, we are using a geostatistical model, which includes latitude and longitude, and therefore we need to generate rasters of these to add to the stack of bioclim2.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create an empty raster with the same extent and resolution as the bioclimatic layers</span><span class="w">
</span><span class="n">latitude_raster</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">longitude_raster</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">raster</span><span class="p">(</span><span class="n">nrows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">bioclim_layers_oromia</span><span class="p">),</span><span class="w">
                                       </span><span class="n">ncols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncol</span><span class="p">(</span><span class="n">bioclim_layers_oromia</span><span class="p">),</span><span class="w">
                                                    </span><span class="n">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extent</span><span class="p">(</span><span class="n">bioclim_layers_oromia</span><span class="p">))</span><span class="w">

</span><span class="c1"># Change the values to be latitude and longitude respectively</span><span class="w">
</span><span class="n">longitude_raster</span><span class="p">[]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">coordinates</span><span class="p">(</span><span class="n">longitude_raster</span><span class="p">)[,</span><span class="m">1</span><span class="p">]</span><span class="w">
</span><span class="n">latitude_raster</span><span class="p">[]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">coordinates</span><span class="p">(</span><span class="n">latitude_raster</span><span class="p">)[,</span><span class="m">2</span><span class="p">]</span><span class="w">

</span><span class="c1"># Now create a final prediction stack of the 4 variables we need</span><span class="w">
</span><span class="n">pred_stack</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">stack</span><span class="p">(</span><span class="n">bioclim_layers_oromia</span><span class="p">[[</span><span class="m">2</span><span class="p">]],</span><span class="w">
                    </span><span class="n">longitude_raster</span><span class="p">,</span><span class="w">
                    </span><span class="n">latitude_raster</span><span class="p">)</span><span class="w">

</span><span class="c1"># Rename to ensure the names of the raster layers in the stack match those used in the model</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">pred_stack</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"bioclim2"</span><span class="p">,</span><span class="w"> </span><span class="s2">"longitude"</span><span class="p">,</span><span class="w"> </span><span class="s2">"latitude"</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">pred_stack</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week6a_intro_spatial_regression_files/figure-gfm/unnamed-chunk-10-1.png" alt="" /><!-- --></p><p>Now we have a stack of rasters of the 4 variables used in the model at the same resolution and extent, we can run the <code class="language-plaintext highlighter-rouge">predict</code> function on the stack to produce a raster of preditions.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Make predictions using the stack of covariates and the model</span><span class="w">
</span><span class="n">predicted_prevalence_raster</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">pred_stack</span><span class="p">,</span><span class="w"> </span><span class="n">glm_mod_2_spatial</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">predicted_prevalence_raster</span><span class="p">)</span><span class="w">
</span><span class="n">lines</span><span class="p">(</span><span class="n">Oromia</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week6a_intro_spatial_regression_files/figure-gfm/unnamed-chunk-11-1.png" alt="" /><!-- --></p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># If you want to clip the predictions to Oromia</span><span class="w">
</span><span class="n">predicted_prevalence_raster_oromia</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mask</span><span class="p">(</span><span class="n">predicted_prevalence_raster</span><span class="p">,</span><span class="w"> </span><span class="n">Oromia</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">predicted_prevalence_raster_oromia</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week6a_intro_spatial_regression_files/figure-gfm/unnamed-chunk-11-2.png" alt="" /><!-- --></p><h4 id="model-validation">Model validation</h4><p>Given that we are interested in building a model in order to make predictions (i.e. a risk map), it is a good idea to validate the model with some independent data. Typically, we do this by removing a fraction of the data (something like 20%) to act as a validation dataset, fitting the model on the remaining 80% and then predicting to the validation set. We can then compare observed versus predicted. If you are being really thorough, you can repeat this process multiple times to make sure every observation has a chance to be in the validation set. This is called v-folds cross-validation. Let’s try the first method.</p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># take 20% to act as validation set</span><span class="w">
</span><span class="n">set.seed</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="n">validation_rows</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">ETH_malaria_data</span><span class="p">),</span><span class="w"> </span><span class="m">40</span><span class="p">)</span><span class="w">
</span><span class="n">ETH_malaria_data_train</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ETH_malaria_data</span><span class="p">[</span><span class="o">-</span><span class="n">validation_rows</span><span class="p">,]</span><span class="w">
</span><span class="n">ETH_malaria_data_valid</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ETH_malaria_data</span><span class="p">[</span><span class="n">validation_rows</span><span class="p">,]</span><span class="w">

</span><span class="c1"># Fit model using 80%</span><span class="w">
</span><span class="n">glm_mod_2_spatial_validation</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">spaMM</span><span class="o">::</span><span class="n">fitme</span><span class="p">(</span><span class="n">cbind</span><span class="p">(</span><span class="n">pf_pos</span><span class="p">,</span><span class="w"> </span><span class="n">examined</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pf_pos</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">bioclim2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Matern</span><span class="p">(</span><span class="m">1</span><span class="o">|</span><span class="n">latitude</span><span class="o">+</span><span class="n">longitude</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">ETH_malaria_data_train</span><span class="p">,</span><span class="w"> </span><span class="n">family</span><span class="o">=</span><span class="n">binomial</span><span class="p">())</span><span class="w">

</span><span class="c1"># PRedict to validation rows and compare</span><span class="w">
</span><span class="n">predictions_validation</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">glm_mod_2_spatial_validation</span><span class="p">,</span><span class="w"> </span><span class="n">ETH_malaria_data_valid</span><span class="p">)</span><span class="w">
</span><span class="n">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">as.vector</span><span class="p">(</span><span class="n">predictions_validation</span><span class="p">),</span><span class="w"> </span><span class="n">ETH_malaria_data_valid</span><span class="o">$</span><span class="n">pf_pr</span><span class="p">))</span><span class="w">
</span></code></pre></div></div><p><img src="https://raw.githubusercontent.com/HughSt/HughSt.github.io/master/_posts/week6a_intro_spatial_regression_files/figure-gfm/unnamed-chunk-12-1.png" alt="" /><!-- --></p><div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Calculate mse</span><span class="w">
</span><span class="n">mse</span><span class="p">(</span><span class="n">predictions_validation</span><span class="p">,</span><span class="w"> </span><span class="n">ETH_malaria_data_valid</span><span class="o">$</span><span class="n">pf_pr</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] 0.000115546
</code></pre></div></div><p>In this session we learnt the basic concepts of spatial regression. We saw how the spatial covariance is an essential component of a spatial model. By encoding the spatial association into a kernel function, a geostatistic model outperforms linear models even when they include a polynomial representation of the observations coordinates. When properly accounting for the spatial structure of the data, the residuals of the model are independent.</p><h2 id="references">References</h2><h3 id="overview-of-glms">Overview of GLMs</h3><p>Fox (2015) Applied Regression Analysis and Generalized Linear. <a href="https://www.sagepub.com/sites/default/files/upm-binaries/21121_Chapter_15.pdf">Chapter 15</a></p><p><a href="https://rss.onlinelibrary.wiley.com/doi/pdf/10.1111/1467-9876.00113">Diggle PJ, Tawn JA, Moyeed RA. Model‐based geostatistics. Journal of the Royal Statistical Society: Series C (Applied Statistics). 1998 Mar;47(3):299-350</a></p><p><a href="https://journals.plos.org/plosntds/article?id=10.1371/journal.pntd.0000958">Pullan RL, Gething PW, Smith JL, Mwandawiro CS, Sturrock HJ, Gitonga CW, Hay SI, Brooker S. Spatial modelling of soil-transmitted helminth infections in Kenya: a disease control planning tool. PLoS neglected tropical diseases. 2011 Feb 8;5(2):e958.</a></p><p><a href="https://www.sciencedirect.com/science/article/pii/S0140673619302260">Mosser JF, Gagne-Maynard W, Rao PC, Osgood-Zimmerman A, Fullman N, Graetz N, Burstein R, Updike RL, Liu PY, Ray SE, Earl L. Mapping diphtheria-pertussis-tetanus vaccine coverage in Africa, 2000–2016: a spatial and temporal modelling study. The Lancet. 2019 May 4;393(10183):1843-55.</a></p><p><a href="https://journals.plos.org/plosntds/article?id=10.1371/journal.pntd.0001194">Schur N, Hürlimann E, Garba A, Traoré MS, Ndir O, Ratard RC, Tchuenté LA, Kristensen TK, Utzinger J, Vounatsou P. Geostatistical model-based estimates of schistosomiasis prevalence among individuals aged≤ 20 years in West Africa. PLoS neglected tropical diseases. 2011 Jun 14;5(6):e1194.</a></p><h3 id="some-more-recent-advances-in-combining-machine-learning-techniques-to-model-the-covariate-effects-with-geostatistics">Some more recent advances in combining machine learning techniques to model the covariate effects with geostatistics</h3><p><a href="https://royalsocietypublishing.org/doi/full/10.1098/rsif.2017.0520">Bhatt S, Cameron E, Flaxman SR, Weiss DJ, Smith DL, Gething PW. Improved prediction accuracy for disease risk mapping using Gaussian process stacked generalization. Journal of The Royal Society Interface. 2017 Sep 20;14(134):20170520.</a></p><p><a href="https://www.nature.com/articles/s41591-019-0525-0">Bhattacharjee NV, Schaeffer LE, Marczak LB, Ross JM, Swartz SJ, Albright J, Gardner WM, Shields C, Sligar A, Schipp MF, Pickering BV. Mapping exclusive breastfeeding in Africa between 2000 and 2017. Nature medicine. 2019 Aug;25(8):1205-12.</a></p></article></div></main><footer class="footer"><div class="container"><nav class="social"></nav><span>&copy; 2022 Applied Spatial Data Science for Public Health. All rights reserved.</span></div></footer><script async src="/assets/js/bundle.js"></script></body></html>
